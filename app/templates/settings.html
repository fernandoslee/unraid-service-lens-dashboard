{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block nav_icons %}<a href="/" class="nav-icon" title="Home"><svg class="icon"><use href="#i-home"/></svg></a>{% endblock %}

{% block content %}
<article>
    <header><h3>Server Connection</h3></header>
    {% if success %}
    <p style="color: #22c55e;">{{ success }}</p>
    {% endif %}
    {% if error %}
    <p class="error-text">{{ error }}</p>
    {% endif %}
    <form method="post" action="/settings">
        <label for="host">Unraid Server Address
            <input type="text" id="host" name="host" value="{{ host }}"
                   placeholder="tower.local or 192.168.1.100" required>
        </label>
        <label for="api_key">API Key
            {% if masked_key %}
            <input type="password" id="api_key" name="api_key"
                   placeholder="{{ masked_key }}"
                   aria-describedby="key-help">
            <small id="key-help" class="dimmed">Leave blank to keep the current key.</small>
            {% else %}
            <input type="password" id="api_key" name="api_key"
                   placeholder="Your Unraid API key" required>
            {% endif %}
        </label>
        <label>
            <input type="checkbox" name="verify_ssl" role="switch"
                   {% if verify_ssl %}checked{% endif %}>
            Verify SSL certificate
        </label>
        <button type="submit">Test Connection & Save</button>
    </form>
</article>

<article>
    <header><h3>Display</h3></header>
    <div class="settings-row">
        <label for="setting-layout">Default layout</label>
        <select id="setting-layout" onchange="saveSetting('defaultView', this.value)">
            <option value="cards">Cards</option>
            <option value="compact">Compact</option>
        </select>
    </div>
    <div class="settings-row">
        <label for="setting-theme">Theme</label>
        <select id="setting-theme" onchange="applyTheme(this.value)">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
            <option value="system">Follow system</option>
        </select>
    </div>
    <hr>
    <p class="dimmed" style="margin-bottom:0.5rem"><small>Sections shown on the dashboard</small></p>
    <div class="settings-row">
        <label for="show-containers">Containers</label>
        <input type="checkbox" id="show-containers" role="switch"
               onchange="saveSetting('showContainers', this.checked)">
    </div>
    <div class="settings-row">
        <label for="show-vms">Virtual Machines</label>
        <input type="checkbox" id="show-vms" role="switch"
               onchange="saveSetting('showVMs', this.checked)">
    </div>
</article>

<article>
    <header><h3>Docker Access</h3></header>
    {% if docker_socket_available %}
    <p style="color: #22c55e;">Docker socket detected</p>
    <p class="dimmed"><small>Container logs are available via the Docker socket.</small></p>
    {% else %}
    <p class="error-text">Docker socket not detected</p>
    <p class="dimmed"><small>To enable container logs, mount the Docker socket in your <code>docker-compose.yml</code>:</small></p>
    <pre style="font-size:0.85em; margin-top:0.5rem"><code>volumes:
  - /var/run/docker.sock:/var/run/docker.sock:ro</code></pre>
    {% endif %}
</article>

<article>
    <header><h3>Authentication</h3></header>
    <form method="post" action="/settings/auth">
        {% if auth_has_password %}
        <label for="current_password">Current password
            <input type="password" id="current_password" name="current_password"
                   placeholder="Enter current password" required>
        </label>
        <hr>
        {% endif %}
        <label>
            <input type="checkbox" name="auth_enabled" role="switch"
                   {% if auth_enabled %}checked{% endif %}>
            Require login
        </label>
        <label for="auth_username">Username
            <input type="text" id="auth_username" name="auth_username"
                   value="{{ auth_username }}" placeholder="admin">
        </label>
        <label for="auth_password">New password
            {% if auth_has_password %}
            <input type="password" id="auth_password" name="auth_password"
                   placeholder="••••••••"
                   aria-describedby="auth-pw-help">
            <small id="auth-pw-help" class="dimmed">Leave blank to keep the current password.</small>
            {% else %}
            <input type="password" id="auth_password" name="auth_password"
                   placeholder="Set a password">
            {% endif %}
        </label>
        <label for="session_max_age">Session duration
            <select id="session_max_age" name="session_max_age">
                <option value="3600" {% if session_max_age == 3600 %}selected{% endif %}>1 hour</option>
                <option value="86400" {% if session_max_age == 86400 %}selected{% endif %}>1 day</option>
                <option value="604800" {% if session_max_age == 604800 %}selected{% endif %}>1 week</option>
                <option value="2592000" {% if session_max_age == 2592000 %}selected{% endif %}>1 month</option>
                <option value="7776000" {% if session_max_age == 7776000 %}selected{% endif %}>3 months</option>
                <option value="31536000" {% if session_max_age == 31536000 %}selected{% endif %}>1 year</option>
            </select>
        </label>
        <button type="submit">Save Authentication</button>
    </form>
</article>

<script>
function saveSetting(key, value) {
    localStorage.setItem(key, value);
}

function applyTheme(theme) {
    localStorage.setItem('theme', theme);
    var t = theme;
    if (t === 'system') {
        t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    }
    document.documentElement.setAttribute('data-theme', t);
}

function getSectionPref(key) {
    var raw = localStorage.getItem(key);
    return raw !== 'false'; // shown by default
}

document.addEventListener('DOMContentLoaded', function() {
    var layout = localStorage.getItem('defaultView') || 'cards';
    document.getElementById('setting-layout').value = layout;

    var theme = localStorage.getItem('theme') || 'dark';
    document.getElementById('setting-theme').value = theme;

    document.getElementById('show-containers').checked = getSectionPref('showContainers');
    document.getElementById('show-vms').checked = getSectionPref('showVMs');
});
</script>
{% endblock %}
